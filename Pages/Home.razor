@page "/"
@using p07_vimkeys_game.Components
@using p07_vimkeys_game.Domain.Entities
@using p07_vimkeys_game.Domain.ValueObjects
@using System.ComponentModel.DataAnnotations
@inject IJSRuntime JS
@implements IValidatableObject

<PageTitle>Vim Keys Game</PageTitle>

<div class="top-info">
<button onclick="gameConfigDialog.showModal()"><h1>Game</h1></button>
<button onclick="configDialog.showModal()"><h1>Keys</h1></button>
<h1>
|
<span class="system-key">&lt;\&gt;@(game.State == GameState.Ready ? "Start" : "Stop")</span>
@foreach (var w in KeyCfg.Values.Where(q => q is not BasicXTimes))
{
  <span class="system-key">@w.CurrentDef@w.Icon</span>
}
| Score: @game.Scores.Item1.ToString("F2")s |
Best: @game.Scores.Item2.ToString("F2")s
</h1>
</div>

<dialog id="gameConfigDialog" @ref="gameConfigDialog" @onclose="OnGameDialogClose" closedby="any" tabindex="-1">
  <h2>Game Configuration</h2>
  <EditForm Model="this" method="dialog" OnValidSubmit="OnGameValidFormSubmit" OnInvalidSubmit="OnGameInvalidFormSubmit">
    <div>
      <label>Grid Version</label>
      <span>
        <label>
          <input type="radio" name="gridVersion" value="v2" checked="@(selectedGridVersion == "v2")" @onchange="OnGridVersionChange" />
          Pick up
        </label>
        <label>
          <input type="radio" name="gridVersion" value="v3" checked="@(selectedGridVersion == "v3")" @onchange="OnGridVersionChange" />
          Fill up
        </label>
      </span>
    </div>
    <div>
      <label>Random Droppables</label>
      <input type="checkbox" checked="@useRandomDroppables" @onchange="OnRandomDroppablesChange" />
    </div>
    <div>
      <label>Droppable Count</label>
      <InputNumber @bind-Value="droppableCount" min="1" max="100" />
    </div>
    <div>
      <label>Show Trail</label>
      <input type="checkbox" checked="@showTrail" @onchange="OnShowTrailChange" />
    </div>
    <div>
      <label>Visit Threshold (Fill up only)</label>
      <InputNumber @bind-Value="visitThreshold" min="1" max="100" />
    </div>
    <button @ref="btnGameSubmit" style="display:none">Submit</button>
  </EditForm>
</dialog>

<dialog id="configDialog" @ref="configDialog" @onclose="OnDialogClose" closedby="any" tabindex="-1">
  <h2>Configure Keybindings</h2>
  <EditForm Model="this" method="dialog" OnValidSubmit="OnValidFormSubmit" OnInvalidSubmit="OnInvalidFormSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    @foreach (var entry in KeyCfg)
    {
      var config = entry.Value;
      <div class="form-row">
        <label>@config.Name @config.Icon</label>
        <span class="system-key">@config.SystemDef</span>
        <InputText @bind-Value="config.UserDef" maxlength="1" tabindex="1" />
        @if (config is BasicXTimes xTimes)
        {
          <InputNumber @bind-Value="xTimes.UserDefinedMultiplier" placeholder="4" min="2" max="9" tabindex="2" />
        }
      </div>
    }
    <button @ref="btnSubmit" style="display:none">Submit</button>
  </EditForm>
</dialog>

<DynamicComponent Type="@gridComponentType"
                  Parameters="@gridParameters" />

@code {
    private Type gridComponentType = typeof(GridV2);
    private string selectedGridVersion = "v2";
    private bool useRandomDroppables = false;
    private int droppableCount = 9;
    private bool showTrail = false;
    private int visitThreshold = 5;

    private Game game = new Game();

    private void OnGridVersionChange(ChangeEventArgs e)
    {
        var version = e.Value?.ToString() ?? "v2";
        selectedGridVersion = version;
        gridComponentType = version switch
        {
            "v2" => typeof(GridV2),
            "v3" => typeof(GridV3),
            _ => typeof(GridV2)
        };
        game.GridVersion = version;
    }

    private void OnRandomDroppablesChange(ChangeEventArgs e)
    {
        useRandomDroppables = (bool)(e.Value ?? false);
        game.UseRandomDroppables = useRandomDroppables;
        game.DroppableCount = droppableCount;
        game.Reset();
    }

    private void OnShowTrailChange(ChangeEventArgs e)
    {
        var newTrailState = (bool)(e.Value ?? false);

        // Simulate visiting/revisiting the current cell
        if (game.State == GameState.Playing)
        {
            var currentPos = game.Player.Position;
            var hasDroppable = game.Droppables.Any(d => !d.IsCollected && d.Position == currentPos);

            if (newTrailState)
            {
                // Enabling: Add current position (like visiting)
                // GridV3: Don't add if it's a droppable cell
                if (!(game.GridVersion == "v3" && hasDroppable))
                {
                    game.VisitedPositions.Add(currentPos);
                }
            }
            else
            {
                // Disabling: Remove current position (like revisiting with trail off)
                game.VisitedPositions.Remove(currentPos);
            }
        }

        showTrail = newTrailState;
        game.ShowTrail = showTrail;
    }

    public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
    {
        var duplicates = KeyCfg.Values
            .Select(d => d.CurrentDef)
            .GroupBy(k => k)
            .Where(g => g.Count() > 1);

        if (duplicates.Any())
        {
            var duplicateKeys = string.Join(", ", duplicates.Select(g => g.Key));
            yield return new ValidationResult(
                $"Duplicate keys detected: {duplicateKeys}. Each movement must have a unique key."
            );
        }
    }

  public static readonly Dictionary<AllConfig, KeyConfig> KeyCfg = AllConfig.None.InitializeDict((KeyConfig[])[
      new BasicMovement(1) { SystemDef = "h", Icon = "⬅" },
      new BasicMovement(2) { SystemDef = "j", Icon = "⬇" },
      new BasicMovement(3) { SystemDef = "k", Icon = "⬆" },
      new BasicMovement(4) { SystemDef = "l", Icon = "➡" },
      new BasicXTimes(1) { SystemDef = "y", Icon = "⬅×4" },
      new BasicXTimes(2) { SystemDef = "u", Icon = "⬇×4" },
      new BasicXTimes(3) { SystemDef = "i", Icon = "⬆×4" },
      new BasicXTimes(4) { SystemDef = "o", Icon = "➡×4" },
  ]);

    // Reference to the dialog elements
    private ElementReference gameConfigDialog, btnGameSubmit;
    private ElementReference configDialog, btnSubmit;

    private Dictionary<string, object> gridParameters => new()
    {
        { "Game", game }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("registerKeyHandler", DotNetObjectReference.Create(this));
        }
    }

    private async Task OnValidFormSubmit()
    {
        var isOpen = await JS.InvokeAsync<bool>("getPropertyAny", configDialog, "open");
        if (isOpen)
        {
            await JS.InvokeVoidAsync("callFunctionAny", configDialog, "close");
        }
    }

    private async Task OnInvalidFormSubmit()
    {
        var isOpen = await JS.InvokeAsync<bool>("getPropertyAny", configDialog, "open");
        if (!isOpen)
        {
            await JS.InvokeVoidAsync("callFunctionAny", configDialog, "showModal");
        }
    }

    private async Task OnDialogClose()
    {
        await JS.InvokeVoidAsync("callFunctionAny", btnSubmit, "click");
    }

    private async Task OnGameValidFormSubmit()
    {
        game.DroppableCount = droppableCount;
        game.UseRandomDroppables = useRandomDroppables;
        game.ShowTrail = showTrail;
        game.VisitThreshold = visitThreshold;
        game.GridVersion = selectedGridVersion;
        game.Reset();

        var isOpen = await JS.InvokeAsync<bool>("getPropertyAny", gameConfigDialog, "open");
        if (isOpen)
        {
            await JS.InvokeVoidAsync("callFunctionAny", gameConfigDialog, "close");
        }
    }

    private async Task OnGameInvalidFormSubmit()
    {
        var isOpen = await JS.InvokeAsync<bool>("getPropertyAny", gameConfigDialog, "open");
        if (!isOpen)
        {
            await JS.InvokeVoidAsync("callFunctionAny", gameConfigDialog, "showModal");
        }
    }

    private async Task OnGameDialogClose()
    {
        await JS.InvokeVoidAsync("callFunctionAny", btnGameSubmit, "click");
    }

    [JSInvokable]
    public void HandleKeyDown(string key, bool ctrlKey, bool shiftKey, bool altKey, bool metaKey)
    {
        // Centralized keyboard shortcut dispatch logic

        // Find matching key in unified config
        var matchingEntry = KeyCfg.FirstOrDefault(q => q.Value.CurrentDef == key);

        if (matchingEntry.Key != AllConfig.None)
        {
            var config = matchingEntry.Value;
            if (config is BasicXTimes xMove)
            {
                game.MovePlayerMultiple(xMove.Direction, xMove.CurrentMultiplier);
            }
            else if (config is BasicMovement basic)
            {
                game.MovePlayer(basic.Direction);
            }
        }
        // Handle Enter key for Start/Reset game
        else if (key == "\\")
        {
            if (game.State == GameState.Ready)
            {
                game.Start();
            }
            else if (game.State == GameState.Playing)
            {
                game.Reset();
            }
        }
        // Handle space key to toggle trail feature
        else if (key == " ")
        {
            var newTrailState = !showTrail;
            showTrail = !showTrail;
            game.ShowTrail = showTrail;
            game.MovePlayer(Direction.None);
        }
        else
        {
            return;
        }
        StateHasChanged();
    }
}
