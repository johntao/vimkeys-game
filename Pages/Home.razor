@page "/"
@using p07_vimkeys_game.Components
@using p07_vimkeys_game.Domain.Entities
@using p07_vimkeys_game.Domain.ValueObjects
@inject IJSRuntime JSRuntime

<PageTitle>Vim Keys Game</PageTitle>

<h1>Vim Keys Game</h1>

<div class="game-info">
    <p>Game State: <strong>@game.State</strong></p>
    <p>Player Position: <strong>(@game.Player.Position.X, @game.Player.Position.Y)</strong></p>
    <p>Remaining Droppables: <strong>@game.RemainingDroppables</strong></p>
    @if (game.Score.HasValue)
    {
        <p>Score: <strong>@game.Score.Value.ToString("F2")s</strong></p>
    }
    <p>Use vim keys: <strong>h</strong>=left, <strong>j</strong>=down, <strong>k</strong>=up, <strong>l</strong>=right</p>
</div>

<div class="game-controls">
    @if (game.State == GameState.Ready)
    {
        <button @onclick="StartGame">Start Game</button>
    }
    @if (game.State == GameState.Playing || game.State == GameState.Completed)
    {
        <button @onclick="ResetGame">Reset Game</button>
    }
</div>

<DynamicComponent Type="@gridComponentType"
                  Parameters="@gridParameters" />

@code {
    // GAME MAKER DECIDES: Change to typeof(GridV1) for anchor-based rendering
    private Type gridComponentType = typeof(GridV2);

    private Game game = new Game();

    private Dictionary<string, object> gridParameters => new()
    {
        { "Game", game }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("registerKeyHandler", DotNetObjectReference.Create(this));
        }
    }

    private void StartGame()
    {
        game.Start();
        StateHasChanged();
    }

    private void ResetGame()
    {
        game.Reset();
        StateHasChanged();
    }

    [JSInvokable]
    public void HandleKeyPress(string key)
    {
        Direction? direction = key switch
        {
            "h" => Direction.Left,
            "j" => Direction.Down,
            "k" => Direction.Up,
            "l" => Direction.Right,
            _ => null
        };

        if (direction.HasValue)
        {
            game.MovePlayer(direction.Value);
            StateHasChanged();
        }
    }
}
