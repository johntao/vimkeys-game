@page "/"
@using p07_vimkeys_game.Components
@using p07_vimkeys_game.Domain.Entities
@using p07_vimkeys_game.Domain.ValueObjects
@inject IJSRuntime JSRuntime

<PageTitle>Vim Keys Game</PageTitle>

<style>
  .top-info>button {
    margin-inline: 2px;
  }
  .top-info {
    font-family: monospace;
    max-width: fit-content;
    margin-inline: auto;
  }
  button>h1 {
    margin-block: 1px;
    font-family: monospace;
  }
  .top-info>h1 {
    display: inline-block
  }
</style>

<div class="top-info">
<button><h1>&lt;SPACE&gt;@(game.State == GameState.Ready ? "Start" : "Stop")</h1></button>
<button><h1>h⬅</h1></button>
<button><h1>j⬇</h1></button>
<button><h1>k⬆</h1></button>
<button><h1>l➡</h1></button>
<h1>
| Score: @game.Scores.Item1.ToString("F2")s |
Best: @game.Scores.Item2.ToString("F2")s
</h1>
</div>

<DynamicComponent Type="@gridComponentType"
                  Parameters="@gridParameters" />

@code {
    // GAME MAKER DECIDES: Change to typeof(GridV1) for anchor-based rendering
    private Type gridComponentType = typeof(GridV2);

    private Game game = new Game();

    private Dictionary<string, object> gridParameters => new()
    {
        { "Game", game }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("registerKeyHandler", DotNetObjectReference.Create(this));
        }
    }

    private void StartGame()
    {
        game.Start();
        StateHasChanged();
    }

    private void ResetGame()
    {
        game.Reset();
        StateHasChanged();
    }

    [JSInvokable]
    public void HandleKeyPress(string key)
    {
        Direction? direction = key switch
        {
            "h" => Direction.Left,
            "j" => Direction.Down,
            "k" => Direction.Up,
            "l" => Direction.Right,
            _ => null
        };

        if (direction.HasValue)
        {
            game.MovePlayer(direction.Value);
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void HandleSpacePress()
    {
        if (game.State == GameState.Ready)
        {
            StartGame();
        }
        else if (game.State == GameState.Playing)
        {
            ResetGame();
        }
    }
}
